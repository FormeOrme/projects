<html>

<head>
    <style>
        body {
            font-size: 0;
            margin: 0;
        }

        .hide {
            display: none !important;
        }
    </style>
</head>

<body>
    <div class="hide">
        <img id="org" src="org.jpg" />
        <img id="src" src="src.jpg" />
    </div>

    <div id="wrapper"></div>

    <canvas id="out"></canvas>
    <script>
        const e = { w: 66, h: 33};
        const MAX_EDGE = ME = 500;

        /* floor : ~~ */

        //ctx.drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight);

        const checkImage = path =>
            new Promise(resolve => {
                const img = new Image();
                img.onload = () => resolve({ path, status: 'ok' });
                img.onerror = () => resolve({ path, status: 'error' });
                img.src = path;
            });
        const loadImg = (...paths) => Promise.all(paths.map(checkImage));
        
        const dist = (d, b) =>
            d.reduce((a, c, i) => {
                a += (c - b[i]) * (c - b[i]);
                return a;
            }, 0);

        /* CUSTOM */
        const S = 2;


        const shard = (/*canvas*/ c, /*index*/ i, p) =>[
            c,
            ...xy(i, c.w, e.w, e.h),
            e.w,e.h,
            ...xy(p, c.w, e.w, e.h),
            e.w,e.h
        ];

        const data = (/*image*/ i, /*index*/ j) =>
            i.c.ctx.d(...[
        /*sx*/
        /*sy*/ ...xy(j, i.c.w, e.w, e.h),
        /*sw*/ e.w,
        /*sh*/ e.h
            ]).data;


        const xy = (/*index*/i, bw, w, h) => [
    /*x*/ w * (i % ~~(bw / w)),
    /*y*/ h * ~~(i / ~~(bw / w))
        ];

        const _xy = (/*index*/p, bw, w, h) => [
        /*x*/ w * (p % ~~(bw / w))   /*+ S*  (p % ~~(bw / w))*/  ,
        /*y*/ h * ~~(p / ~~(bw / w)) /*+ S*~~(p / ~~(bw / w))*/
        ];

        const fillCanvas = (/*image*/ i, /*resizedata*/ r) => {
            const c = document.createElement("canvas");
            c.w = c.width = r.w;
            c.h = c.height = r.h;
            var ctx = c.getContext("2d");
            c.ctx = ctx;

            var sw = i.w * r.w / r._w;
            var sh = i.h * r.h / r._h;
            var sx = (i.w - sw) / 2;
            var sy = (i.h - sh) / 2;

            ctx.drawImage(i, sx, sy, sw, sh, 0, 0, c.w, c.h);
            // ctx.drawImage(o, ~~(o.w/e.w), ~~(o.h/e.h), co.w, co.h, 0, 0, co.w, co.h);
            ctx.d = ctx.getImageData;

            return c;
        }

        loadImg("src.jpg", "org.jpg").then(() => {
            const o = org;
            o.w = o.width;
            o.h = o.height;
            const s = src;
            s.w = s.width;
            s.h = s.height;

            const no = {
                _w: o.w > o.h ? ME : (o.w / o.h) * ME,
                _h: o.w > o.h ? (o.h / o.w) * ME : ME
            };
            no.w = e.w * ~~(no._w / e.w);
            no.h = e.h * ~~(no._h / e.h);

            org.canvas = org.c = fillCanvas(org, no);
            wrapper.append(org.c);

            const n = (org.c.w * org.c.h) / (e.w * e.h);
            console.log(n);

            /* 4) Resize source so that it contains N pieces too */


            out.width = 700;
            out.height = 700;

            /*            
            const arr = [];
            for(var i = 0; i < n; i++){
                arr.push({
                    data : data(org, i),
                    i:i
                });
            }
            */
            const random= ()=>{
                var pos = Array.apply(null, {length: n}).map(Number.call, Number);
                otx = out.getContext("2d");

                for(var i = 0; i < n; i++){
                    otx.drawImage( ...shard(org.c, i, pos.splice(~~(Math.random()*pos.length), 1)) );
                }
            }
            random();
            out.addEventListener("mousemove", random);
            
            /*
            
            const co = document.createElement("canvas");
            co.w = co.width  = e.w*~~(o.w/e.w);
            co.h = co.height = e.h*~~(o.h/e.h);
            var ctx = co.getContext("2d");
            co.ctx = ctx;
            ctx.d = ctx.getImageData;
            ctx.drawImage(o, ~~(o.w/e.w), ~~(o.h/e.h), co.w, co.h, 0, 0, co.w, co.h);
            org.canvas = org.c = co;
            wrapper.append(co);
                
            var nh = ~~Math.sqrt(  ( s.h*o.w*o.h )/s.w );
            var nw = ~~((s.w*nh)/s.h);
    
            const cs = document.createElement("canvas");
            cs.w = cs.width  = e.w*~~(nw/e.w);
            cs.h = cs.height = e.h*~~(nh/e.h);
            var ctx = cs.getContext("2d");
            cs.ctx = ctx;
            ctx.d = ctx.getImageData;
            ctx.drawImage(src, 0, 0);
            src.canvas = src.c = cs;
            wrapper.append(cs);
            */

            /* SOURCE TILE SIZE */
            // const r = {}
            // r.h = Math.sqrt((e.h * e.h * s.w * s.h) / (o.w * o.h));
            // r.w = (e.w * r.h) / e.h;

            const p = {
                o: o,
                s: s,
                ctx: out.getContext("2d")
            };

            window.p = p;
        });

    </script>
</body>

</html>