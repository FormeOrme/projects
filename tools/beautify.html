<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Beautify</title>
        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
            rel="stylesheet"
        />
        <!-- js-beautify libraries -->
        <script src="https://cdn.rawgit.com/beautify-web/js-beautify/v1.13.6/js/lib/beautify.js"></script>
        <script src="https://cdn.rawgit.com/beautify-web/js-beautify/v1.13.6/js/lib/beautify-html.js"></script>
        <!-- Prism.js for syntax highlighting -->
        <link
            href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism.min.css"
            rel="stylesheet"
        />
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-markup.min.js"></script>
        <script type="module">
            import SUtils from "../module/SUtils.js";
            import { Div, H1, Label, TextArea, Pre } from "../module/Dom.js";

            const BEAUTIFY_OPTIONS = {
                indent_size: 4,
                indent_char: " ",
                max_preserve_newlines: 5,
                preserve_newlines: true,
                keep_array_indentation: false,
                break_chained_methods: false,
                indent_scripts: "normal",
                brace_style: "collapse",
                space_before_conditional: true,
                unescape_strings: false,
                jslint_happy: false,
                end_with_newline: false,
                wrap_line_length: 0,
                indent_inner_html: false,
                comma_first: false,
                e4x: false,
                indent_empty_lines: false,
            };

            document.addEventListener("DOMContentLoaded", () => {
                // Build UI using Dom.js classes
                const inputId = "input";
                const outputId = "output";

                const app = Div.with({
                    class: ["container", "py-5"],
                    children: [
                        H1.with({ class: "mb-4", innerText: "Beautify JSON / XML" }),
                        Div.with({
                            class: "mb-3",
                            children: [
                                Label.with({
                                    for: inputId,
                                    class: "form-label",
                                    innerText: "Paste JSON or XML here:",
                                }),
                                TextArea.with({
                                    id: inputId,
                                    class: ["form-control", "font-monospace"],
                                    rows: 5,
                                    spellcheck: false,
                                }),
                            ],
                        }),
                        Div.with({
                            children: [
                                Label.with({
                                    for: outputId,
                                    class: "form-label",
                                    innerText: "Beautified Output:",
                                }),
                                Pre.with({
                                    id: outputId,
                                    class: ["form-control", "language-json"],
                                    readonly: true,
                                }),
                            ],
                        }),
                    ],
                }).create();

                document.body.innerHTML = "";
                document.body.appendChild(app);

                const input = document.getElementById(inputId);
                const output = document.getElementById(outputId);

                window.addEventListener("focus", () => {
                    input.focus();
                    input.select();
                });

                input.addEventListener("input", () => {
                    const iValue = input.value.trim();
                    let lang = "";
                    let pretty = "";
                    let errorMsg = "";
                    let className = "form-control";

                    const format = SUtils.detectDataFormat(iValue);
                    if (format === "json") {
                        lang = "json";
                        try {
                            pretty = window.js_beautify(iValue, BEAUTIFY_OPTIONS);
                        } catch {
                            errorMsg = "Invalid JSON";
                        }
                    } else if (format === "xml") {
                        lang = "markup";
                        try {
                            pretty = window.html_beautify(iValue, BEAUTIFY_OPTIONS);
                        } catch {
                            errorMsg = "Invalid XML/HTML";
                        }
                    } else if (iValue) {
                        errorMsg = "Unsupported format. Please paste valid JSON or XML.";
                    }

                    if (errorMsg) {
                        output.textContent = errorMsg;
                        output.className = `${className} language-${lang || "plain"} border-danger`;
                        Prism.highlightElement(output);
                        return;
                    }
                    if (pretty) {
                        output.textContent = pretty;
                        output.className = `${className} language-${lang}`;
                        Prism.highlightElement(output);
                    } else {
                        output.textContent = "";
                        output.className = className;
                    }
                });
                input.focus();
            });
        </script>
    </head>

    <body></body>
</html>
