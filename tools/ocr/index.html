<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>OCR Tool</title>

        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
        />
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
        />
    </head>

    <body spellcheck="false">
        <script type="module">
            import { createWorker } from "https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.esm.min.js";
            import { Dom, Div, H1, Input, Pre } from "../../module/Dom.js";

            const container = Div.with({
                class: "container",
                children: [
                    H1.with({
                        innerText: "OCR",
                    }),
                    Input.with({
                        class: "form-control form-control-sm mb-1",
                        attribute: {
                            type: "file",
                            title: "input",
                        },
                        event: {
                            input: (e, node) => {
                                parse(node.files[0]);
                            },
                        },
                    }),
                    Div.with({
                        id: "progressContainer",
                        class: "progress mb-1 position-relative",
                        attribute: {
                            style: "height: 30px",
                        },
                        children: [
                            Div.with({
                                id: "progressPercent",
                                class: "progress-bar",
                            }),
                            Div.with({
                                id: "progressSpinner",
                                class: "spinner-grow text-primary position-absolute top-50 start-50 translate-middle",
                            }),
                        ],
                    }),
                    Pre.with({
                        class: "form-control form-control-sm",
                        id: "output",
                    }),
                ],
            }).create();
            document.querySelector("body").append(container);

            const progressSpinner = Dom.nodes.querySelector("#progressSpinner");
            const progressPercent = Dom.nodes.querySelector("#progressPercent");
            const output = Dom.nodes.querySelector("#output");

            progressSpinner.classList.add("d-none");

            let worker;

            async function initWorker() {
                if (!worker) {
                    worker = await createWorker("eng", 1, {
                        logger: (l) => {
                            const progress = !l.jobId ? 0 : l.progress;
                            if (progress != 0) {
                                progressSpinner.classList.add("d-none");
                                progressPercent.classList.remove("d-none");
                            }
                            progressPercent.style = `width: ${(progress * 100).toFixed(0)}%`;
                        },
                    });
                }
                return worker;
            }

            async function parse(file) {
                progressPercent.classList.add("d-none");
                progressSpinner.classList.remove("d-none");

                const worker = await initWorker();
                const {
                    data: { text },
                } = await worker.recognize(file);
                output.innerText = text;
            }

            document.querySelector("body").addEventListener("paste", (event) => {
                const clipboardData = event.clipboardData || window.clipboardData;
                const items = clipboardData.items;

                for (let i = 0; i < items.length; i++) {
                    if (items[i].type.indexOf("image") !== -1) {
                        parse(items[i].getAsFile());
                    }
                }
            });
        </script>
    </body>
</html>
