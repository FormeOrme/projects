<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Prices</title>
        <link
            rel="icon"
            type="image/svg+xml"
            href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='-6 -6 112 112'>
    <text x='50' y='85' font-size='100' text-anchor='middle'>ðŸ‘›</text>
</svg>"
        />
        <style>
            body {
                font-family: Arial, sans-serif;
                margin: 20px;
                display: flex;
                justify-content: center;
                align-items: center;
            }
            table {
                border-collapse: collapse;
            }
            th,
            td {
                border: 1px solid #ddd;
                padding: 8px;
                text-align: left;
            }
            th {
                background-color: #f2f2f2;
            }
            tr:nth-child(even) {
                background-color: #f9f9f9;
            }
            tr:hover {
                background-color: #e9e9e9;
            }
        </style>
    </head>
    <body>
        <script type="module">
            import { asc } from "../../module/Sort.js";
            import { Dom, Div, Table, TH, TD, TR, Span, A } from "../../module/Dom.js";
            /*
                                // data is an object with appids as keys and obejcts with price info as values:
                        "data": {
                            "903630": {
                                "title": "The Last Cube",
                                "url": "https://gg.deals/game/the-last-cube/",
                                "prices": {
                                    "currentRetail": "7.99",
                                    "currentKeyshops": null,
                                    "historicalRetail": "7.99",
                                    "historicalKeyshops": "2.75",
                                    "currency": "USD"
                                }
                            },
                                */

            class Prices {
                constructor({
                    currentRetail,
                    currentKeyshops,
                    historicalRetail,
                    historicalKeyshops,
                }) {
                    this.currentRetail = parseFloat(currentRetail);
                    this.currentKeyshops = parseFloat(currentKeyshops);
                    this.historicalRetail = parseFloat(historicalRetail);
                    this.historicalKeyshops = parseFloat(historicalKeyshops);
                }

                getMinCurrent() {
                    return Math.min(
                        isNaN(this.currentRetail) ? Infinity : this.currentRetail,
                        isNaN(this.currentKeyshops) ? Infinity : this.currentKeyshops,
                    );
                }

                getMinCurrentLabel() {
                    const min = this.getMinCurrent();
                    return min === Infinity ? "N/A" : min.toFixed(2);
                }

                getMinHistoricalLabel() {
                    const min = this.getMinHistorical();
                    return min === Infinity ? "N/A" : min.toFixed(2);
                }

                getMinHistorical() {
                    return Math.min(
                        isNaN(this.historicalRetail) ? Infinity : this.historicalRetail,
                        isNaN(this.historicalKeyshops) ? Infinity : this.historicalKeyshops,
                    );
                }

                getDifference() {
                    return this.getMinCurrent() - this.getMinHistorical();
                }

                getDifferenceLabel() {
                    const diff = this.getDifference();
                    return isNaN(diff) || diff === Infinity ? "N/A" : diff.toFixed(2);
                }
            }

            class GameInfo {
                constructor({ title, url, prices }) {
                    this.title = title;
                    this.url = url;
                    this.prices = new Prices(prices);
                }
            }

            const ids = [
                903630, 1297210, 1101370, 1349230, 1727420, 1898290, 1260520, 1683370, 1592170,
                1972450, 2094910, 1602560, 835960, 2239150, 1931770, 2246640, 2736590, 1371980,
                1364490, 1814170, 2071500, 3337850, 2785810, 3093400, 2574970, 2806640, 2273430,
                1809540, 1086940, 1903340, 2193540, 2870430, 1619520, 2140020, 2186680, 1206560,
                1313290, 3401490, 2198150, 2273850, 1296610, 3784030, 3024040, 2719750, 2444750,
                2090580, 2797650, 2288470, 1782460, 2213300, 1564220, 851670, 1581480, 12500,
                3226530, 3073990, 3606690, 2820820, 2893350, 1617400, 3256040, 3219180, 2459560,
                2001120, 1426210, 1392860, 1206430, 1435790, 2879840, 1701330, 2596420, 1172450,
                2716690, 1052990, 753640, 557600, 1255560, 1994000, 3011360, 3808690, 3631290,
                3282420, 3908810, 499170, 2784470, 4239080,
            ];

            const prices = await fetch("./prices.json");
            const json = await prices.json();
            const data = json.data;
            const priceInfos = ids
                .map((id) => new GameInfo(data[id]))
                .sort(asc((pi) => pi.prices.currentKeyshops));

            const table = Table.with({
                children: [
                    TR.with({
                        children: [
                            TH.with({ innerText: "Game" }),
                            TH.with({ innerText: "Current Price" }),
                            TH.with({ innerText: "Historical Low" }),
                            TH.with({ innerText: "Difference" }),
                        ],
                    }),
                    ...priceInfos.map((pi) =>
                        TR.with({
                            children: [
                                TD.with({
                                    children: Span.with({
                                        children: A.with({
                                            innerText: pi.title,
                                            attribute: {
                                                href: pi.url,
                                                target: "_blank",
                                            },
                                        }),
                                    }),
                                }),
                                TD.with({
                                    innerText: pi.prices.getMinCurrentLabel(),
                                }),
                                TD.with({
                                    innerText: pi.prices.getMinHistoricalLabel(),
                                }),
                                TD.with({
                                    innerText: pi.prices.getDifferenceLabel(),
                                }),
                            ],
                        }),
                    ),
                ],
            });

            console.log(table);

            console.log(new Table(new TR([new TH("Hello"), new TH("World")])).create());

            document.body.appendChild(table.create());
        </script>
    </body>
</html>
