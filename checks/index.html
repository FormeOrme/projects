<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- v4 -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@4/dist/tesseract.min.js'></script>
    <script src="../util.js"></script>
    <title>Document</title>
    <link rel="stylesheet" href="index.css">
</head>

<body>
    <script>

        const payers = ["Forme", "Andrea", "Dave", "Emma", "Teo"];

        const columns = {
            description: {
                header: TH.with({
                    innerText: "Description"
                }),
                row: t => TD.with({
                    children: Input.with({
                        class: "description",
                        value: t.trim().match(/(.+)\d+,\d{2}$/g)?.at(0) ?? t
                    })
                }),
                footer: TH.with()
            },
            amount: {
                header: TH.with({
                    innerText: "Amount"
                }),
                row: t => TD.with({
                    children: Input.with({
                        class: "amount",
                        value: t.trim().match(/(\d+,\d{2})$/g)?.at(0).replace(",", ".") ?? "",
                        attribute: {
                            type: "number",
                            content: "amount",
                            step: ".1"
                        },
                        event: {
                            input: () => updateTotals()
                        }
                    })
                }),
                footer: TH.with({
                    children: Input.with({
                        id: "total",
                        class: "amount",
                        attribute: {
                            readonly: true,
                            type: "number"
                        }
                    })
                })
            },
            payerList: {
                header: payers.map(p =>
                    TH.with({
                        innerText: p
                    })
                ),
                row: t => payers.map(p => TD.with({
                    children: Input.with({
                        attribute: {
                            type: "checkbox",
                            payer: p,
                        },
                        event: {
                            click: () => updateTotals()
                        }
                    })
                })),
                footer: payers.map(p =>
                    TH.with({
                        children: Input.with({
                            id: `total_${p}`,
                            class: "amount",
                            attribute: {
                                readonly: true,
                                type: "number",
                                payer: p
                            }
                        })
                    })
                )
            },
            delete: {
                header: TH.with({
                    innerText: "Delete"
                }),
                row: t => TD.with({
                    children: Button.with({
                        class: "delete",
                        event: {
                            click: (e) => {
                                e.target.closest("tr").remove();
                                updateTotals();
                            }
                        }
                    })
                }),
                footer: TH.with({
                    children: Button.with({
                        class: "add",
                        event: {
                            click: (e) => {
                                const body = document.getElementById("mainBody");
                                body.append(getRow().create());
                            }
                        }
                    })
                })
            }
        }

        const getRow = (t = "") => TR.with({
            children: [
                columns.delete.row(t),
                columns.description.row(t),
                columns.amount.row(t),
                ...columns.payerList.row(t),
            ]
        })

        const getTable = (text = "") => Table.with({
            children: [
                THead.with({
                    children: TR.with({
                        children: [
                            columns.delete.header,
                            columns.description.header,
                            columns.amount.header,
                            ...columns.payerList.header,
                        ]
                    })
                }),
                TBody.with({
                    id: "mainBody",
                    children: text?.trim().split(/\n/g).map(getRow)
                }),
                TFoot.with({
                    children: TR.with({
                        children: [
                            columns.delete.footer,
                            columns.description.footer,
                            columns.amount.footer,
                            ...columns.payerList.footer,
                        ]
                    })
                })
            ]
        });

        const buildTable = text => {
            const tableContainer = document.getElementById("TableContainer");
            tableContainer.innerText = "";
            tableContainer.append(getTable(text).create());
        }

        const updateTotals = () => {
            const total = document.getElementById("total");
            total.value = 0;
            [...document.querySelectorAll("[content='amount']")].forEach(q => {
                total.value = +total.value + (+q.value ?? 0);
            });
            total.value = Math.floor(+total.value * 100) / 100;

            payers.forEach(p => {
                const total = document.getElementById(`total_${p}`);
                total.value = 0;
                [...document.querySelectorAll("tbody tr")].forEach(tr => {
                    const amount = +tr.querySelector("[content='amount']")?.value ?? 0;
                    const checked = [...tr.querySelectorAll("input[type='checkbox']:checked")];
                    const payr = tr.querySelector(`[payer="${p}"]`);
                    if (payr.checked) {
                        total.value = +total.value + amount / checked.length;
                    }
                });
                total.value = (+total.value).toFixed(2);
            })
        }

        document.querySelector("body").append(Div.with({
            children: [
                Div.with({
                    id: "progressContainer"
                }),
                Div.with({
                    children: [
                        Input.with({
                            attribute: {
                                type: "file"
                            },
                            event: {
                                input: (e, node) => {
                                    try {
                                        Utils.context.progressContainer.show();
                                        Tesseract.recognize(
                                            node.files[0],
                                            'eng',
                                            {
                                                logger: l => {
                                                    const progress = !l.jobId ? 0 : l.progress;
                                                    Utils.context.progressContainer.node.setAttribute("progress", progress.toFixed(2));
                                                }
                                            }
                                        ).then(({ data: { text } }) => {
                                            Utils.context.progressContainer.hide();
                                            buildTable(text);
                                            updateTotals();
                                        });
                                    } catch (e) {
                                        console.log(e);
                                    }
                                }
                            }
                        })
                    ]
                }),
                Div.with({
                    id: "TableContainer"
                })
            ]
        }).create());
        Utils.context.progressContainer.hide();
        buildTable();
    </script>
</body>

</html>