<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Projects</title>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css"
        />
    </head>

    <body>
        <script type="module">
            import { Octokit, App } from "https://esm.sh/octokit";
            import { FN } from "./module/Dom.js";
            const { A, UL, LI, Span, Section, IFrame, H1 } = FN;
            import { alpha, multiSort } from "./module/Sort.js";
            import { strip } from "./module/SUtils.js";

            const octokit = new Octokit({});

            const repo = "projects";

            class TreeNode {
                constructor(value) {
                    this.value = value;
                    this.children = [];
                }

                addChildren(children) {
                    this.children = children.map((child) => new TreeNode(child));
                    return this;
                }
            }

            class Content {
                constructor({ name, path, html_url, type }) {
                    this.name = name;
                    this.path = path;
                    this.html_url = html_url;
                    this.type = type;
                }

                get isFolder() {
                    return this.type === "dir";
                }

                get icon() {
                    return this.isFolder ? "ðŸ“" : "ðŸ“„";
                }

                get url() {
                    return new URL(this.html_url);
                }
            }

            class TreeRenderer {
                constructor({ repo }) {
                    this.repo = repo;
                    this.owner = "FormeOrme";
                }

                async mostRecentCommit() {
                    const response = await octokit.request("GET /repos/{owner}/{repo}/commits", {
                        owner: this.owner,
                        repo: this.repo,
                    });
                    return response.data[0]?.sha;
                }

                async getRepoContents(repo, path = "") {
                    let get = "GET /repos/{owner}/{repo}/contents";
                    if (path) {
                        get = "GET /repos/{owner}/{repo}/contents/{path}";
                    }
                    const owner = this.owner;
                    const response = await octokit
                        .request(get, {
                            owner,
                            repo,
                            path,
                        })
                        .then((response) =>
                            new TreeNode().addChildren(
                                response.data.map((item) => new Content(item)),
                            ),
                        );
                    return response;
                }

                async renderBranch(path) {
                    const { children, value } = await this.getRepoContents(this.repo, path);
                    const list = UL({
                        class: ["list-group", path ? "m-1" : ""],
                        children: await Promise.all(
                            children
                                .sort(
                                    multiSort(
                                        alpha(({ value }) => value.type),
                                        alpha(({ value }) => value.name),
                                    ),
                                )
                                .map((leaf) => this.renderLeaf(leaf)),
                        ),
                    });
                    return list;
                }

                async renderLeaf({ value }) {
                    switch (value.type) {
                        case "dir":
                            return await this.renderFolder({ value });
                        case "file":
                            return this.renderFile({ value });
                        default:
                            return LI({
                                class: "list-group-item",
                                text: value.name,
                            });
                    }
                }

                renderFile({ value }) {
                    return LI({
                        class: "file-leaf list-group-item p-0 overflow-hidden",
                        children: Span({
                            class: "btn btn-outline-primary w-100 text-start border-0 rounded-0",
                            children: [
                                Span({
                                    text: value.icon,
                                    class: "p-1",
                                }),
                                Span(value.name),
                            ],
                        }),
                        event: {
                            click: (node, event) => {
                                event.stopPropagation();
                                const isActive = node.isActive();

                                if (!isActive) {
                                    const fileLeaves = document.querySelectorAll(".file-leaf");
                                    fileLeaves.forEach((leaf) => leaf.toggleActive(false));

                                    const url = `./${value.path}`;
                                    const iframe = document.getElementById("iframe");
                                    iframe.src = url;

                                    const title = document.getElementById("title");
                                    title.innerText = "";
                                    title.append(
                                        A({
                                            class: "text-truncate",
                                            text: url,
                                            attribute: {
                                                href: url,
                                                target: "_blank",
                                            },
                                        }).create(),
                                    );

                                    node.toggleActive(true);
                                }
                            },
                        },
                        function: {
                            isActive: function () {
                                return this.classList.contains("open");
                            },
                            toggleActive: function (active) {
                                this.classList.toggle("open", active);
                            },
                        },
                    });
                }

                async renderFolder({ value }) {
                    // const list = await this.renderBranch(value.path);

                    const childrenContainer = Span({
                        class: "d-none",
                    });

                    const liElement = LI({
                        id: strip(value.name),
                        class: "list-group-item p-0 overflow-hidden",
                        children: [
                            Span({
                                class: "btn btn-outline-primary w-100 text-start border-0 rounded-0",
                                children: [
                                    Span({
                                        text: value.icon,
                                        class: "p-1",
                                    }),
                                    Span({
                                        class: "cursor-pointer",
                                        text: value.name,
                                    }),
                                ],
                            }),
                            childrenContainer,
                        ],
                        event: {
                            click: async (node, event) => {
                                event.stopPropagation();

                                const isActive = node.isActive();

                                const container = childrenContainer.node;

                                if (isActive) {
                                    container.classList.toggle("d-none", true);
                                    node.toggleActive(false);
                                } else {
                                    const list = await this.renderBranch(value.path);
                                    container.innerHTML = "";
                                    container.appendChild(list.create());
                                    container.classList.toggle("d-none", false);
                                    node.toggleActive(true);
                                }
                            },
                        },
                        function: {
                            isActive: function () {
                                return this.classList.contains("open");
                            },
                            toggleActive: function (active) {
                                this.classList.toggle("open", active);
                            },
                        },
                    });

                    return liElement;
                }
            }

            (async () => {
                const treeRenderer = new TreeRenderer({ repo });

                const leafList = await treeRenderer.renderBranch();
                document.body.appendChild(
                    Section({
                        class: "container",
                        id: "projects",
                        children: [
                            H1({
                                class: "text-center",
                                text: `Projects : ${await treeRenderer.mostRecentCommit()}`,
                            }),
                            Section({
                                class: "row",
                                children: [
                                    Section({
                                        id: "tree",
                                        class: "col-3",
                                        children: leafList,
                                    }),
                                    Section({
                                        id: "iframe-container",
                                        class: "col-9 sticky-top",
                                        children: [
                                            Span({
                                                id: "title",
                                            }),
                                            IFrame({
                                                id: "iframe",
                                                class: "w-100 h-100 border rounded",
                                            }),
                                        ],
                                    }),
                                ],
                            }),
                        ],
                    }).create(),
                );
            })();
        </script>
    </body>
</html>
